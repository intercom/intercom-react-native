#!/bin/sh

#
# Functions
#
function log() {
  echo "\n"
  echo "======================================="
  echo "$1"
  echo "======================================="
}



EXPECTED_RUBY_VERSION=$(cat ${SOURCE_ROOT_DIR}/.ruby-version)
ruby_version="2.4.4"
rbenv_version="2.5.7"

log "ðŸŽï¸  Running React native setup script ðŸŽï¸"

log "ðŸ“± Installing xcode tools ðŸ“±"

if [ ! -f /Library/Developer/CommandLineTools/usr/lib/libxcrun.dylib ]; then
  echo "âš ï¸ Xcode CommandLineTools not found installing. Please install and rerun this script âš ï¸"
  xcode-select --install
  exit 1
fi
echo "Xcode CommandLineTools installed ðŸ‘"

if ! [ -x "$(command -v xcode-select)" ]; then
  echo "âš ï¸ You need Xcode to setuo this project. Please install and rerun this script âš ï¸"
  exit 1s
fi

log "ðŸ‘€ Looking for Homebrew ðŸ‘€"
if ! [ -x "$(command -v brew)" ]; then
  echo "ðŸº Installing Homebrew ðŸº"
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  echo 'export PATH=/opt/homebrew/bin:$PATH' >> ~/.bash_profile
  echo 'export PATH=/opt/homebrew/bin:$PATH' >> ~/.zshrc
else
  echo "Homebrew already installed ðŸ‘"
fi

log "ðŸ‘€ Looking for rbenv ðŸ‘€"

if ! [ -x "$(command -v rbenv)" ]; then
  echo "ðŸº Installing rbenv with brew ðŸº"
  brew install rbenv
  echo 'eval "$(rbenv init -)"' >> ~/.bash_profile
  echo 'eval "$(rbenv init -)"' >> ~/.zshrc
  eval "$(rbenv init -)"
  rbenv install "2.5.7"
else
  rbenv install "2.5.7"
  echo "rbenv already installed ðŸ‘"
fi
rbenv local "2.5.7"

log "ðŸ‘€ Looking for yarn ðŸ‘€"
if ! [ -x "$(command -v yarn)" ]; then
  echo "ðŸº Installing yarn ðŸº"
  brew install yarn
else
  echo "yarn already installed ðŸ‘"
fi

log "ðŸ‘€ Looking for ruby ðŸ‘€"
ruby-build --definitions | grep ^${EXPECTED_RUBY_VERSION} > /dev/null
RUBYBUILD_DEFS_EXIT_CODE=$?
if [ "$RUBYBUILD_DEFS_EXIT_CODE" -ne 0 ]; then
    echo "ðŸº Ruby Build: Cannot find Ruby version required, updating via brew ðŸº"
    brew update && brew upgrade ruby-build
fi
rbenv install --skip-existing
echo "Ruby installed ðŸ‘"

log "ðŸ“Ÿ installing dependencies ðŸ“Ÿ"
yarn

log "ðŸ“Ÿ installing dependencies for our example app ðŸ“Ÿ"
cd example/ios
pod install
cd -

echo "You're all set up ðŸ‘"
echo "ðŸ“± Run example app on iOS using -> yarn example ios"
echo "ðŸ“± Run example app on android using -> yarn example android"
